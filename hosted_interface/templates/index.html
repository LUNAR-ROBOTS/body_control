<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Joystick Control</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.7.3/nipplejs.min.js"></script>
    </head>
    <body>
        <h1>Control Interface</h1>
        <div id="response"></div>
        <div id="joystick-container" style="width: 200px; height: 200px; border: 1px solid black;"></div>

        <form id="action1" onsubmit="submitAction(event, 'action1')">
            <button type="submit">Action 1</button>
        </form>
        <form id="action2" onsubmit="submitAction(event, 'action2')">
            <button type="submit">Action 2</button>
        </form>
        <form id="action3" onsubmit="submitAction(event, 'action3')">
            <button type="submit">Action 3</button>
        </form>
        <form id="action4" onsubmit="submitAction(event, 'action4')">
            <button type="submit">Action 4</button>
        </form>
        <form id="take_picture" onsubmit="takePicture(event)">
            <button type="submit">Take Picture</button>
        </form>
        <form id="start_stream" onsubmit="startStream(event)">
            <button type="submit">Start Stream</button>
        </form>
        <form id="stop_stream" onsubmit="stopStream(event)">
            <button type="submit">Stop Stream</button>
        </form>
        <img id="picture" src="" alt="Picture will appear here">
        <div>
            <img id="video" src="/video_feed" alt="Video stream will appear here">
        </div>

        <script>
            function submitAction(event, action) {
                event.preventDefault(); // Prevent form from submitting normally
                fetch('/' + action, { method: 'POST' })
                    .then(response => response.text())
                    .then(text => document.getElementById('response').innerText = text)
                    .catch(error => console.error('Error:', error));
            }

            function takePicture(event) {
                event.preventDefault();
                fetch('/take_picture', { method: 'POST' })
                    .then(response => response.blob())
                    .then(blob => {
                        const url = URL.createObjectURL(blob);
                        document.getElementById('picture').src = url;
                    })
                    .catch(error => console.error('Error:', error));
            }

            function startStream(event) {
                event.preventDefault();
                fetch('/start_stream', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => console.log(data))
                    .catch(error => console.error('Error:', error));
            }

            function stopStream(event) {
                event.preventDefault();
                fetch('/stop_stream', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => console.log(data))
                    .catch(error => console.error('Error:', error));
            }

            // Joystick setup
            var joystick = nipplejs.create({
                zone: document.getElementById('joystick-container'),
                mode: 'static',
                position: { left: '50%', top: '50%' },
                color: 'red'
            });

            joystick.on('move', function (evt, data) {
                if (data.direction) {
                    let position = {
                        x: data.position.x,
                        y: data.position.y
                    };
                    fetch('/joystick', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(position)
                    })
                    .then(response => response.text())
                    .then(text => console.log(text))
                    .catch(error => console.error('Error:', error));
                }
            });

        </script>
    </body>
</html>